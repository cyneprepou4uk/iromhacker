<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html">
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<title>Ромхакинг NES. Введение в ромхакинг NES</title>
		<meta name="description" content="Базовое описание ромхакинга 8-битной консоли. Basic information about NES rom hacking stuff">
		<meta name="keywords" content="">
		<link rel="icon" href="https://iromhacker.ru/favicon.png" type="image/png">
		<link href="https://iromhacker.ru/style.css" rel="stylesheet">
		<script src="https://iromhacker.ru/analytics.js"></script>
		<script src="https://iromhacker.ru/bitrix24.js" async></script>
	</head>
	<body>
		<h1>Введение в ромхакинг NES</h1>
		<p>
			<center>
				<a class="return" href="https://iromhacker.ru/nes/ru/index.html">Вернуться на главную страницу</a>
			</center>
		</p>
		<br>
		<p class="content">
			Содержание
		</p>
		<ul>
			<li>Введение в ромхакинг NES</li>
			<li><a href="../2/index.html">Системы счисления</a></li>
		</ul>
		<h2>Введение в ромхакинг NES</h2>
		<h3>Nintendo Entertainment System</h3>
		<p>
			Для эмуляции игр NES существуют множество эмуляторов, например Nestopia, FCEUX, Mednafen и другие. Эмулятор игровой консоли эмулирует ее различные компоненты, такие как центральный процессор, видеопроцессор и аудиопроцессор.
		</p>
		<p>
			Чтобы поиграть в какую-то игру, нужно найти ROM (образ) этой игры. ROM содержит в себе копию данных с микросхемы картриджа.
		</p>
		<p>
			Игры могут отличаться по размеру программы PRG (Program) и графики CHR (Character), а также по другим параметрам, например по номеру маппера (устройство управления расширенной памятью). Чтобы эмулятор мог правильно эмулировать данный ROM, в начале каждого файла есть специальная строчка из 16 байт, называемая "хедер" (header).
		</p>
		<p class="tip">
			Строчки с хедером нету в памяти картриджа, она была придумана для эмуляторов.
		</p>
		<h3>Эмулятор FCEUX</h3>
		<p>
			Данный эмулятор не только эмулирует игру, но еще позволяет отображать ее "внутренности", например оперативную память (RAM), видеопамять и графику. В нем также есть инструменты для отладки и редактирования кода, и еще много чего полезного для ромхакинга.
		</p>
		<p>
			Выбери опцию из списка, чтобы почитать базовую информацию по NES.
		</p>
		<p>
			<table class="tab" border=1 cellspacing=1 cellpadding=5>
				<tr>
					<td colspan="2" class="tabLink" onclick="openTab(event, 'CPU')">CPU</td>
					<td class="tabLink" onclick="openTab(event, 'RAM')">RAM</td>
					<td class="tabLink" onclick="openTab(event, 'PRG')">PRG ROM</td>
					<td class="tabLink" onclick="openTab(event, 'Assembly')">Программирование на NES</td>
					<td class="tabLink" onclick="openTab(event, 'PPU')">PPU</td>
					<td class="tabLink" onclick="openTab(event, 'Tiles')">Тайловая графика</td>
					<td class="tabLink" onclick="openTab(event, 'APU')">APU</td>
				</tr>
			</table>
		</p>
		<p>
			<div id="CPU" class="tabcontent">
				<h2>Центральный процессор</h2>
				<p>
					Центральным процессором (CPU) является 8-битный микропроцессор на основе MOS Technology 6502.
				</p>
				<p>
					Размер памяти процессора = 64 KB. Каждая ячейка памяти называется "адрес", в каждом адресе хранится 1 байт. В статьях адреса будут записаны четырьмя символами с префиксом "$".
				</p>
				<p>
					64 KB = диапазон адресов $0000-$FFFF. У процессора 16-битная адресная шина, что позволяет ему обращаться к любому адресу этого диапазона.
				</p>
				<p>
					<img src="https://i.imgur.com/KL6EMU4.gif"><!--0010-->
				</p>
				<p>
					Память разбита на несколько участков. Самыми примечательными являются RAM и PRG ROM. Остальные адреса это зеркала RAM, память батарейки (при ее наличии) и различные регистры (включая их зеркала).
				</p>
			</div>
		</p>
		<p>
			<div id="RAM" class="tabcontent">
				<h2>RAM</h2>
				<p>
					Оперативная память размером 2 KB, она находится в диапазоне $0000-$07FF. RAM служит для хранения динамических данных игрового процесса, таких как количество жизней, координаты объектов, номер уровня, таймеры и прочее. Обычно адрес RAM хранит в себе числовое количество чего-либо.
				</p>
				<p>
					<img src="https://i.imgur.com/EkmKh08.gif"><!--0011-->
				</p>
				<p>
					Каждый отдельный адрес из этих 2048-ми адресов может отвечать за какую-то определенную задачу, или же просто быть свободным (который совсем не используется игрой). Некоторые схожие адреса, например координаты объектов, очень часто находятся по соседству.
				</p>
				<p class="tip">
					Только разработчики игры решают за что будет отвечать каждый из этих адресов, и скорее всего адрес, который отвечает за какую-то функцию, в другой игре будет находиться в совершенно другом месте. Схожее расположение адресов в лучшем случае ты встретишь у игр одной серии, или в играх одной и той же компании.
				</p>
				<p>
					Несмотря на такое большое количество адресов, найти нужный адрес, который отвечает за определенную игровую функцию, не так уж и сложно.
				</p>
				<p>
					Чтобы внести в игру некие изменения, нужно повлиять на адрес, который отвечает за соответствующую игровую функцию. Свободные адреса можно использовать самому для хранения каких-то новых динамических данных.
				</p>
			</div>
		</p>
		<p>
			<div id="PRG" class="tabcontent">
				<h2>PRG ROM</h2>
				<p>
					Программа (PRG) размером 32 KB в диапазоне $8000-$FFFF. Здесь размещен код и игровые данные, например текст, таблица уровней, параметры персонажей и другие. Большинство статических данных и констант будут храниться именно здесь. Динамические данные находятся в адресах RAM.
				</p>
				<p>
					<img src="1.png">
				</p>
				<h3>Дополнительная память</h3>
				<p>
					Крупным играм недостаточно 32 KB памяти, и тогда на помощь приходит маппер. Он позволяет подключать в эту область различные "банки" памяти из файла ROM'а, таким образом в том же диапазоне $8000-$FFFF в другой момент времени может мгновенно оказаться совершенно иной код с данными.
				</p>
				<p class="tip">
					Возможность, метод переключения банков памяти и их размер зависят от маппера.
				</p>
				<p>
					Обычно массивные игровые программы, такие как отрисовка графики, вычисление физики, музыкальный движок и другие, находятся в отдельных банках и подключаются на протяжении кадра в том порядке, в котором запрограммирован основной игровой скрипт.
				</p>
			</div>
		</p>
		<p>
			<div id="Assembly" class="tabcontent">
				<h2>Программирование на NES</h2>
				<p>
					Игры для NES написаны на языке ассемблера процессора 6502. Это низкоуровневый язык программирования, в котором программа является байт-кодом. Эти байты интерпретируются как набор инструкций.
				</p>
				<p>
					<img src="2.png">
				</p>
				<p class="tip">
					Предназначение данной подпрограммы - записать байт #$0F по адресам $00CF-$00DF и $0427-$0437.
				</p>
				<h3>Начало кода</h3>
				<p>
					Точкой входа в программу (игру) является 16-битный адрес, младший и старший байт которого указаны в $FFFC-$FFFD. Затем происходит базовая загрузка игры, такая как отрисовка различных игровых экранов и заставок. Дальнейшие игровые события развиваются благодаря нажатию кнопок на джойстике.
				</p>
				<p>
					Редактируя код игры, можно изменять геймплей и игровые данные. Для этого требуется знание инструкций и регистров процессора.
				</p>
			</div>
		</p>
		<p>
			<div id="PPU" class="tabcontent">
				<h2>PPU</h2>
				<p>
					Центральный процессор общается с видеопроцессором (PPU) при помощи регистров. В регистры передается старший и младший байты адреса для чтения/записи байтов видеопамяти, позиция скроллинга, включение/отключение графики и прочее.
				</p>
				<h3>Редактирование графики</h3>
				<p>
					Для редактирования тайлов (графики NES) обычно используются универсальные тайловые редакторы вроде YY-CHR. Менять палитру не составляет труда. С редактированием титульных экранов иногда нужно повозиться.
				</p>
				<p>
					Для некоторых популярных игр существуют специализированные редакторы, позволяющие не только менять графику, но также конструировать уровни, изменять расположение врагов и прочее.
				</p>
			</div>
		</p>
		<p>
			<div id="Tiles" class="tabcontent">
				<h2>Тайловая графика</h2>
				<p>
					Графика NES состоит из тайлов. Тайл - изображение размером 8x8 пикселей.
				</p>
				<p>
					<img src="3.png">
				</p>
				<p>
					Часть графики предназначена для фона, а часть для спрайтов (изображений поверх фона).
				</p>
				<h3>Отображение на экране</h3>
				<p>
					Игра комбинирует различные тайлы, располагает их на экране в нужном месте, и в итоге получается привычная нам картинка. Например, для анимации прыжка Марио используются 8 тайлов, которые выводятся на экране как спрайты.
				</p>
				<p>
					<img src="4.png">
				</p>
				<h3>Дополнительные тайлы</h3>
				<p>
					Если игре понадобятся новые наборы тайлов, например для отображения логотипа, алфавита, новых видов врагов и так далее, она может подключить в видеопамять другую область с тайлами вместо одной из текущих, или же вручную перерисовать некоторые тайлы на другие.
				</p>
				<p class="tip">
					Как и в случае с банками PRG, возможность, метод переключения банков CHR (графики) и их размер зависят от маппера.
				</p>
				<h3>Палитра</h3>
				<p>
					Для фона и для спрайтов выделено по 4 набора цветов, в каждом наборе по 3 уникальных цвета + 1 цвет фона.
				</p>
				<p>
					<img src="5.png">
				</p>
				<p>
					Память спрайтов содержит информацию о том, какой номер палитры будет использован каждым отдельным спрайтом. Фон указывает палитру для своих тайлов сразу для размера 16x16 пикселей (4 тайла).
				</p>
			</div>
		</p>
		<p>
			<div id="APU" class="tabcontent">
				<h2>APU</h2>
				<p>
					Центральный процессор общается с аудиопроцессором (APU) при помощи регистров. В регистры передается информация о нотах, длительности звука, громкости и прочее.
				</p>
				<h3>Музыка</h3>
				<p>
					Всего есть 5 музыкальных каналов, которые генерируют звуковые сигналы, и в итоге получается звук/музыка. 
				</p>
				<p class="tip">
					На некоторых мапперах, например MMC5 и VRC6, больше возможностей аудиопроцессора.
				</p>
				<h3>Редактирование музыки</h3>
				<p>
					Редактирование музыки является самым сложным видом ромхакинга, поскольку в играх не существует какого-то единого формата хранения данных музыки. Звуковой движок везде отличается, и разобраться в нем может быть непросто даже для опытного ромхакера.
				</p>
				<p>
					Свою музыку можно написать при помощи программы Famitracker.
				</p>
			</div>
		</p>
		<script src="https://iromhacker.ru/spoiler.js"></script>
		<script src="https://iromhacker.ru/tab.js"></script>
	</body>
</html>